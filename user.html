<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0,
user-scalable=no">
    <title>User</title>
    <script src="./qrcode.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
<div id="qr" hidden>
    <div id="qrtext"></div>
    <button onclick="hideQR()">Back</button>
    <div id="qrcode"></div>
</div>
<div id="details">
    <div id="adminControls" class="admin" hidden>
        <button onclick="window.location.href='inspect'">Inspect</button>
    </div>
    <div id="userControls">
        <button onclick="window.location.href='validate'">Validate</button>
    </div>
    <div>
        USER:
        <button onclick="showQR($('#userId').html(), $('#userName').html())">Show QR</button>
        <div id="userId">ID</div>
        <div id="userName">NAME</div>
        <div id="userEmail">EMAIL</div>
        <div id="userIdCard">IDCARD</div>
        <div id="userType">TYPE</div>
    </div>
    <div>
        <hr/>
        TICKETS:
        <table id="tickets" border="1">
            <tr>
                <th>ID</th>
                <th>Valid From</th>
                <th>Valid Until</th>
                <th>Last Validated</th>
                <th>Type</th>
                <th>QR</th>
                <th>Validate</th>
            </tr>
        </table>
    </div>
    <div>
        <hr/>
        TICKET TYPES:
        <table id="ticketTypes" border="1">
            <tr>
                <th>ID</th>
                <th>NAME</th>
                <th>TYPE</th>
                <th>LINE NAME</th>
                <th>BUY</th>
            </tr>
        </table>
    </div>
    <div class="admin" hidden>
        <hr/>
        VEHICLES:
        <table id="vehicles" border="1">
            <tr>
                <th>ID</th>
                <th>VALIDATE ID</th>
                <th>TYPE</th>
                <th>LICENCE PLATE</th>
                <th>QR</th>
            </tr>
        </table>
    </div>
</div>

<script>
    getUser();
    getVehicles();
    getTicketTypes();

    function showQR(qrcode, title) {
        $('#qrcode').html('');
        $('#details').hide();
        $('#qr').show();
        $('#qrtext').html(title);
        new QRCode(document.getElementById('qrcode'), qrcode);
    }

    function hideQR() {
        $('#details').show();
        $('#qr').hide();
    }

    function getUser() {
        $.getJSON('/api/user/', function (user) {
            $('#userId').html(user.id);
            $('#userName').html(user.name);
            $('#userEmail').html(user.email);
            $('#userIdCard').html(user.idCard);
            $('#userType').html(user.type);
            if(user.type === 'user') {
                $('.user').show();
            } else {
                $('.admin').show();
            }
            getTickets(user.id);
        });
    }

    function getTickets(id) {
        $('#tickets tr').not(':first').remove();
        $.getJSON(`/api/user/${id}/tickets/`, function(tickets) {
            let html = '';
            tickets.forEach(ticket => {
                html += `<tr><td>${ticket.id}</td><td>${ticket.validFrom}</td><td>${ticket.validUntil}</td><td>${ticket.lastValidated}</td><td>${ticket.ticketType.name}</td><td><button onclick="showQR('${ticket.id}', '${ticket.ticketType.name}')">Show QR</button></td><td><button onclick="window.location.href='validate?ticketId=${ticket.id}'">Validate</button></td></tr>`;
            });
            $('#tickets tr').first().after(html);
        });
    }

    function buyTicket(id) {
        $.post('/api/tickets/buy/', {typeId: id}, function (ticket) {
            getTickets($('#userId').html());
        });
    }

    function getTicketTypes() {
        $('#ticketTypes tr').not(':first').remove();
        $.getJSON(`/api/tickets/`, function(tickets) {
            let html = '';
            tickets.forEach(ticket => {
                html += `<tr><td>${ticket.typeId}</td><td>${ticket.name}</td><td>${ticket.type}</td><td>${ticket.line ? ticket.line.name : '-'}</td><td><button onclick="buyTicket('${ticket.typeId}')">BUY</button></td></tr>`;
            });
            $('#ticketTypes tr').first().after(html);
        });
    }

    function getVehicles() {
        $('#vehicles tr').not(':first').remove();
        $.getJSON(`/api/vehicles/`, function(vehicles) {
            let html = '';
            vehicles.forEach(vehicle => {
                html += `<tr><td>${vehicle.id}</td><td>${vehicle.validateId}</td><td>${vehicle.type}</td><td>${vehicle.licencePlate}</td><td><button onclick="showQR('${vehicle.validateId}', '${vehicle.licencePlate}')">Show QR</button></td></tr>`;
            });
            $('#vehicles tr').first().after(html);
        });
    }
</script>
</body>
</html>
